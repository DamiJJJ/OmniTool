{% extends "base.html" %} {% block title %}To-Do List - OmniTool{% endblock %} {% block content %}
<div class="container mt-4">
  <h1 class="mb-4 text-center">To-Do List</h1>

  <div class="card p-4 shadow-sm mb-4">
    <form method="POST" action="{{ url_for('todo.todo_list') }}" class="mb-4">
      {{ form.csrf_token }}
      <div class="mb-3">
        <label for="description" class="form-label">Task Description</label>
        {{ form.description(class="form-control", placeholder="Add a new task...", required=True) }}
      </div>
      <div class="row g-3 mb-3">
        <div class="col-md-6">
          <label for="deadline" class="form-label">Deadline</label>
          {{ form.deadline(class="form-control") }}
        </div>
        <div class="col-md-6">
          <label for="priority" class="form-label">Priority</label>
          {{ form.priority(class="form-select") }}
        </div>
      </div>
      <button class="btn btn-primary w-100" type="submit">Add Task</button>
      {% if form.description.errors %}
      <div class="alert alert-danger mt-2">
        {% for error in form.description.errors %}
        <span>{{ error }}</span>
        {% endfor %}
      </div>
      {% endif %}
    </form>

    {% if todos %}
    <ul class="list-group">
      {% for task in todos %}
      <li
        class="list-group-item d-flex justify-content-between align-items-center {% if task.completed %}list-group-item-success{% endif %}"
        data-task-id="{{ task.id }}"
      >
        <div class="d-flex align-items-center">
          <form class="complete-form me-3">
            <input class="form-check-input" type="checkbox" name="completed_task" {% if task.completed %} checked {% endif %} />
          </form>
          <span class="task-description {% if task.completed %}text-decoration-line-through text-muted{% endif %}">{{ task.description }}</span>
          {% if task.priority %} {% if task.priority == 1 %}
          <span class="badge bg-danger ms-2">High Priority</span>
          {% elif task.priority == 2 %}
          <span class="badge bg-warning text-dark ms-2">Medium Priority</span>
          {% else %}
          <span class="badge bg-success ms-2">Low Priority</span>
          {% endif %} {% endif %} {% if task.deadline %}
          <small class="text-muted ms-2"> Deadline: {{ task.deadline.strftime('%Y-%m-%d') }} </small>
          {% endif %}
        </div>
        <div class="d-flex gap-2">
          <a href="{{ url_for('todo.edit_todo', task_id=task.id) }}" class="btn btn-sm btn-info" title="Edit Task">
            <i class="fas fa-edit"></i>
          </a>
          <a href="{{ url_for('todo.delete_todo', task_id=task.id) }}" class="btn btn-sm btn-danger" title="Delete Task">
            <i class="fas fa-trash-alt"></i>
          </a>
        </div>
      </li>
      {% endfor %}
    </ul>
    {% else %}
    <p class="text-center">No tasks found. Add a new task above!</p>
    {% endif %}
  </div>
</div>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const completeForms = document.querySelectorAll(".complete-form");
    completeForms.forEach((form) => {
      const checkbox = form.querySelector(".form-check-input");
      checkbox.addEventListener("change", (e) => {
        const listItem = form.closest(".list-group-item");
        const taskId = listItem.dataset.taskId;
        const isChecked = e.target.checked;
        const taskDescription = listItem.querySelector(".task-description");

        checkbox.disabled = true;

        fetch(`/todo/complete/${taskId}`)
          .then((response) => {
            listItem.classList.toggle("list-group-item-success", isChecked);
            taskDescription.classList.toggle("text-decoration-line-through", isChecked);
            taskDescription.classList.toggle("text-muted", isChecked);
          })
          .catch((error) => {
            console.error("Error completing task:", error);
            checkbox.checked = !isChecked;
          })
          .finally(() => {
            checkbox.disabled = false;
          });
      });
    });
  });
</script>
{% endblock %}
